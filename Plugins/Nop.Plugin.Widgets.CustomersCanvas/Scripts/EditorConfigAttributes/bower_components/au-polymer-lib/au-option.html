<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-selector/iron-selector.html">



<link rel="import" href="aurigma-color-scheme-picker.html">
<link rel="import" href="aurigma-dropdown-list.html">

<dom-module id="au-option">
    <template>
        <style>
        iron-label {
            font-weight: 900;
        }
        
        :host {
            --paper-menu-background-color: transparent;
            --paper-radio-button-unchecked-color:var(--theme-secondary-color);
            --paper-radio-button-checked-color:var(--theme-primary-color);
            --paper-checkbox-checked-color:var(--theme-primary-color);
            --paper-checkbox-unchecked-color:var(--theme-secondary-color);

            --paper-input-container-color:var(--theme-secondary-color);
            --paper-input-container-focus-color:var(--theme-primary-color);
            --paper-input-container-input-color:var(--theme-secondary-color);
            --paper-input-container-underline:var(--theme-primary-color);
        }
        
        paper-radio-button /deep/ #offRadio {
            @apply --au-option-radio-button-off;
        }
        
        paper-radio-button[checked] /deep/ #onRadio {
            @apply --au-option-radio-button-on;
        }
        
        .radio-button-content {
            @apply --au-option-radio-button-content;
        }
        
        paper-radio-button {
            width: var(--au-option-radio-button-width, 100%);
        }
        .color-option-container{
            display:inline-block;
        }
        .color-option.iron-selected {
            border:solid 1px var(--google-grey-300,lightgray);
            box-shadow:0px 0px 14px 3px currentColor;
            opacity:1;
            @apply --shadow-transition;
            @apply --au-option-color-option-selected;
        }
        
        .color-option::before {
            width: 100%;
            height: 100%;
            content: '';
            @apply --aurigma-option-color-option-bg;
            background-size: 100% 100%;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            opacity:1;
            @apply --au-option-color-option-before;
        }
        
        .color-option {
            position:relative!important;
            width: 50px;
            height: 50px;
            display: inline-block;
            margin: 1%;
            opacity:0.9;
            @apply --shadow-elevation-6dp;
            @apply --au-option-color-option;
        }
        
        .option-menu {
            width: 100%;
            height: 100%;
            display: flex;
            flex-wrap: wrap;
            flex-direction: row;
            align-content: flex-start;
            align-items: center;
        }
        fieldset {
            border:none;
        }
        .option-checkbox-container > *{
            padding:12px;
        }
        *, *:before, *:after {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
     /*   aurigma-dropdown-list{
            padding-left: 10px;
        }*/
     /*   .raised{
            @apply --shadow-elevation-2dp;
        }*/
        </style>
        <!--  

        var optionTypes = {
            1: "list", // DropdownList
            2: "radio", // RadioList
            3: "checkbox", // Checkboxes
            4: "text", // TextBox -
            10: "textarea", // MultilineTextbox
            20: "date", // Datepicker -
            30: "file", // FileUpload -
            40: "color", // ColorSquares
            45: "image",  // ImageSquares размер
            50: "readonlycheckbox" // ReadonlyCheckboxes -
        };
        OptionValue {
            this.id
            this.defaultValue 
            this.preselected 
            this.title
            this.price
        }
       Option {
            id 
            description
            prompt
            title 
            type 
            required
            defaultValue 
            values = {...name:OptionValue};
        }
        -->
        <!-- Regular radio buttons -->
        <template is="dom-if" if="[[_isOption(option,'checkbox')]]" on-dom-change="_onOptionShow">
            <fieldset>
            <legend>[[title]]</legend>
                <iron-selector id="option" class="option-checkbox-container" attr-for-selected="name" multi selected-values="[[selectedIds]]" on-change="_onOptionChange" selected-attribute="checked">
                    <template is="dom-repeat" items="[[optionArray]]">
                        <paper-checkbox name="{{item.id}}">
                            <span class="subtitle paragraph-text">
                                [[item.title]]
                            </span>
                        </paper-checkbox>
                    </template>
                </iron-selector>
            </fieldset>
        </template>
        <!-- Regular radio buttons -->
        <template is="dom-if" if="[[_isOption(option,'radio')]]" on-dom-change="_onOptionShow">
            <fieldset>
            <legend>[[title]]</legend>
                <paper-radio-group id="option" class="option-menu" attr-for-selected="name" selected="[[selectedIds]]" selected-attribute="checked" on-change="_onOptionChange">
                    <template is="dom-repeat" items="[[optionArray]]">
                        <paper-radio-button name="{{item.id}}">
                            <div class="radio-button-content paragraph-text">{{_getItemPriceTitle(item)}}</div>
                        </paper-radio-button>
                    </template>
                </paper-radio-group>
            </fieldset>
        </template>
        <!-- Color swatches -->
         <template is="dom-if" is="dom-if" if="[[_isOption(option,'color')]]" on-dom-change="_onOptionShow">
            <fieldset>
            <legend>[[title]]</legend>
                <iron-selector id="option" class="color-option-container" attr-for-selected="name" selected="[[selectedIds]]" on-selected-changed="_onOptionChange">
                    <template is="dom-repeat" items="[[optionArray]]">
                        <div name="{{item.id}}" role="menuitemradio" style$="{{_getIconStyle(item)}}" class="color-option"></div>
                    </template>
                </iron-selector>
            </fieldset>
        </template>
        <!-- Dropdown list  -->
        <template is="dom-if" if="[[_isOption(option,'list')]]" on-dom-change="_onOptionShow">
             <fieldset>
             <legend>[[title]]</legend>
                <aurigma-dropdown-list title="[[option.title]]" selected-values="[[selectedIds]]" attr-for-selected="name" on-change="_onOptionChange" class="raised">
                    <template is="dom-repeat" items="[[optionArray]]">
                            <paper-item name="[[item.id]]">[[item.title]]</paper-item>
                    </template>
                </aurigma-dropdown-list>
             </fieldset>
        </template>
         <!-- textarea  -->
        <template is="dom-if" if="[[_isOption(option,'textarea')]]" on-dom-change="_onOptionShow">
            <fieldset>
                <legend>[[title]]</legend>
                <paper-textarea  id="option" on-change="_onOptionChange">[[option.defaultValue]]</paper-textarea>
           </fieldset>
        </template>
        <!-- text -->
        <template is="dom-if" if="[[_isOption(option,'text')]]" on-dom-change="_onOptionShow">
             <fieldset>
                <legend>[[title]]</legend>
                <paper-input  id="option" on-change="_onOptionChange">[[option.defaultValue]]</paper-input>
             </fieldset>
        </template>
        <!-- aurigma-color-scheme-picker  experimental-->
        <template is="dom-if" if="[[_isOption(option,'colorScheme')]]" on-dom-change="_onOptionShow">
             <fieldset>
             <legend>[[title]]</legend>
                <aurigma-color-scheme-picker 
                    id="option"
                    title="[[option.title]]" 
                    color-schemes="[[option.colorSchemes]]" 
                    default-scheme-index="[[option.defaultSchemeIndex]]" 
                    show-palette-preview="[[option.showPalettePreview]]" 
                    preview-palette-max-number="[[option.previewPaletteMaxNumber]]" 
                    enabled="[[option.enabled]]" 
                    on-change="_onOptionChange">
                </aurigma-color-scheme-picker>
            </fieldset>
        </template>
    </template>
    <script>
    Polymer({
        is: 'au-option',
        properties: {
            option: {
                type: Object,
                notify: true,
                observer: '_optionChanged'
            },
            optionArray:{
                type: Array,
                computed:"_getOptionArray(option)"
            },
            title:{
                type: Array,
                computed:"_getOptionTitle(option)"
            },
            order: {
                type: Object,
            },
            selectedIds: {
                type: Array,
                value: [],
            },
            optionElement: {
                type: HTMLElement,
                value: null,
            },
        },

        _onOptionChange:function(){
            this.async(function(){
                this.notifyPath("selectedIds");
                this.renotify();
            },5);
        },
        _onOptionShow:function(){
            var optElement = this.$$("#option");
            if(optElement){
                this.optionElement = optElement;
            }
        },

        observers: [
            '_onUpdate(order, option)'
        ],
         _getArrayElement:function(array, index){
            return array[index];
         },
        _getIconStyle: function(item) {
            var style = [];
            if (!!item.image) {
                style.push("background-image: url(" + item.image + ")");
                style.push("background-size: cover");
                style.push("color:white");
            } else if (!!item.color) {
                style.push("background-color:" + item.color);
                style.push("color:" + item.color);
            }
            return style.join(";");
        },
        _getSelectedIds: function(selectedItems){
            if(selectedItems){
                return selectedItems.map(function(item){
                    return item.id;
                })
            }
            return [];
        },
        _getSelectedItems: function(selectedIds){
            if(selectedIds){
                var self = this;
                return selectedIds.map(function(id){
                    return self.optionArray.find(function(opt){
                        return opt.id == id;
                    });
                })
            }
            return [];
        },
        _smartSelection: function() {
            if (!!this.order && !!this.order.options && !!this.order.options[this.option.title] &&  typeof this.order.options[this.option.title].value != "undefined") {
                return this.order.options[this.option.title].value;
            } else {
                var preselectValue = this.optionArray.filter(function(item) {
                    return !!item.preselected;
                });
                if (preselectValue.length > 0) {
                    return preselectValue;
                } else {
                    var nonPriceValue = this.optionArray.filter(function(item) {
                        return item.price == 0;
                    });
                    return nonPriceValue;
                }
            }
        },
        _onUpdate: function(order, option) {
            if (order && option) {
                this.selectedIds = this._smartSelection().map(function(item){return item.id})
            }
        },
        _isOption: function(option, type) {
            return option && option.type && type && option.type.toLowerCase() == type.toLowerCase();
        },
        ready: function() {
            this.optionElement = this.$$("#option");
        },

        renotify: function() {
           
                this._selectionChanged()
          
        },

        _selectionChanged: function() {
            if (this.option) {
                var items = this._getSelectedItems(this.selectedIds);
                if (!!this.order) {
                    this.order.setOptionByTitle(this.option.title, items);
                }
                this.fire('changed', {
                    newOption: items
                });
            }
        },

        _getItemPriceTitle: function(item) {
            var priceTag = item.price != 0 ? " (adds $" + item.price.toString() + ")" : "";
            return item.title + priceTag;
        },
        _getOptionArray:function(option){
            return option ? Object.keys(this.option.values).map(function(key) {
                return this.option.values[key];
            }, this) : [];
        },
        _getOptionTitle:function(option){
            var title = "";
            if (option) {
                title = this.option.title;
                if (this.option.prompt) {
                    title = this.option.prompt;
                } else if (this.option.description) {
                    title = this.option.description;
                }
            }
            return title;
        },
        _optionChanged: function() {
            if (!!this.option) {
                this.fire('changed', {
                    newOption:  this._getSelectedItems(this.selectedIds)
                });
            }
        },


    });
    </script>
</dom-module>
<!-- 
в base-magnetqueen используются обычные опции, не как в нопе
т.е. там нет понятия optionId, поэтому там все selectedOptionId 
заменены на selectedOptionTitle.
Соответственно, посмотреть dropDown опции. Сейчас там используется title
 -->