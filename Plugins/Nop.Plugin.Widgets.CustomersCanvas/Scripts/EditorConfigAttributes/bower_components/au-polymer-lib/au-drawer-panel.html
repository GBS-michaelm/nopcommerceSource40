<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<dom-module id="au-drawer-panel">
    <template>
        <style include="">
        :host {
            display: inline-block;
            width: 100%;
            min-height: 300px;
            overflow: hidden;
            @apply --aurigma-drawer-panel;
        }
        
        .drawer-container {
            display: inline-block;
            height: 100%;
            width: 100%;
            position: static;
            @apply --aurigma-drawer-container;
        }
        
        .drawer-main {
            position: absolute;
            top: 0;
            left: var(--aurigma-drawer-main-panel-desktop-left, 30%);
            right: 0;
            bottom: 0;
            z-index: 500;
        }
        
        .drawer-drawer {
            display: table;
            /**inline-block*/
            width: var(--aurigma-drawer-panel-desktop-width, 30%);
            height: 100%;
            z-index: 501;
            position: relative;
            @apply --aurigma-drawer;
        }
        
        .drawer-container.mobile .drawer-drawer {
            width: var(--aurigma-drawer-panel-mobile-width, 70%);
            transform: translateX(-100%);
            transition: transform 2s;
        }
        
        .drawer-container.mobile .drawer-main {
            left: var(--aurigma-drawer-main-panel-mobile-left, 0);
            transition: left 0.8s;
        }
        
        .drawer-container.mobile.open .drawer-drawer {
            transform: translateX(0);
            transition: transform 2s;
        }
        
        .drawer-main >::content > [main] {
            height: 100%;
            @apply --aurigma-drawer-panel-main-container;
        }
        
        .drawer-drawer >::content > [drawer] {
            height: 100%;
            @apply --aurigma-drawer-panel-drawer-container;
        }
        
        .drawer-container:not(.mobile)::content [au-drawer-toggle] {
            display: none;
        }
        </style>
        <iron-media-query id="mq" on-query-matches-changed="_onQueryMatchesChanged" query="[[_computeMediaQuery(responsiveWidth)]]">
        </iron-media-query>
        <div class="drawer-container" id="container">
            <div class="drawer-main">
                <content select="[main]"></content>
            </div>
            <div class="drawer-drawer">
                <content select="[drawer]"></content>
            </div>
        </div>
    </template>
    <script>
    Polymer({
        is: 'au-drawer-panel',
        behaviors: [Polymer.IronResizableBehavior],
        properties: {
            open: {
                type: Boolean,
                value: false,
                notify: true,
                observer: "_onOpenStateChange"
            },
            responsiveWidth: {
                type: String,
                value: '768px'
            },
            showDrawer: {
                type: Boolean,
                value: true,
                observer: "_showDrawerChange"
            },
        },
        attached: function() {
            var self = this;
            Array.from(self.querySelectorAll("[au-drawer-toggle]")).forEach(function(el) {
                el.addEventListener("tap", function() {
                    self.toggle();
                });
            });
            Array.from(self.querySelectorAll("[au-drawer-sticky]")).forEach(function(el) {
                self._attachStickyDrawerHandler(el);
            });
        },
        _attachStickyDrawerHandler: function(element) {
            var positionHandler = function() {
                var top = this.getBoundingClientRect().top;
                element.style.top = top < 0 ? Math.abs(top) + "px" : 0;
            }.bind(this);
            window.addEventListener("scroll", positionHandler);
            window.addEventListener("resize", positionHandler);
        },
        _computeMediaQuery: function(responsiveWidth) {
            return '(max-width: ' + responsiveWidth + ')';
        },
        _onQueryMatchesChanged: function(event) {
            this._responsiveChange(event.detail.value);
        },
        _responsiveChange: function(mobile) {
            this._toggle(this.$.container, "mobile", mobile);
            this.open = false;
        },
        toggle: function() {
            this.open = !this.open;
        },
        _showDrawerChange: function(showDrawer) {
            if (typeof showDrawer != "undefined") {
                var main = this.$$(".drawer-main");
                var drawer = this.$$(".drawer-drawer");

                main.style.left = showDrawer ? "" : 0;
                drawer.style.width = showDrawer ? "" : 0;
                drawer.style.visibility = showDrawer ? "" : "hidden";
            }
        },
        _onOpenStateChange: function(isOpen) {
            this._toggle(this.$.container, "open", isOpen);
        },
        _toggle: function(element, className, toggle) {
            if (typeof toggle == "undefined") {
                if (element.classList.contains(className)) {
                    element.classList.remove(className);
                } else {
                    element.classList.add(className);
                }
            } else {
                if (toggle) {
                    if (!element.classList.contains(className)) {
                        element.classList.add(className);
                    }
                } else {
                    element.classList.remove(className);
                }
            }
        }
    });
    </script>
</dom-module>
